# Interactive Open Questions Resolution for /ideate-to-spec

**Slug:** spec-open-questions-workflow
**Author:** Claude Code
**Date:** 2025-11-21
**Branch:** feat/spec-open-questions-workflow
**Related:** specs/package-publishing-strategy/02-specification.md, .claude/commands/ideate-to-spec.md

---

## 1) Intent & Assumptions

- **Task brief:** Extend the `/ideate-to-spec` command to interactively resolve open questions in specifications after `/spec:create` or `/spec:validate`, ensuring specs are fully ready for decomposition before proceeding.

- **Assumptions:**
  - Specifications generated by `/spec:create` may contain an "Open Questions" section
  - Users want to resolve these questions before starting implementation
  - The interactive prompting should mirror the existing ideation clarifications flow (Step 2 of `/ideate-to-spec`)
  - Focus on happy path - user completing the flow, not cancellation scenarios
  - The workflow should loop until all open questions are answered
  - `/spec:validate` can detect whether open questions remain unanswered

- **Out of scope:**
  - Handling user cancellation mid-flow
  - Automated answering of questions (all require user input)
  - Creating new specs from open questions (defer to later work)
  - Modifying `/spec:create` command behavior
  - Changing the structure of the "Open Questions" section

---

## 2) Pre-reading Log

- `.claude/commands/ideate-to-spec.md`: Current workflow implementation with 7 steps
  - **Takeaway:** Step 2 already implements interactive decision gathering for ideation clarifications using structured format
  - **Takeaway:** Step 6 calls `/spec:validate` but doesn't handle validation failures or open questions
  - **Takeaway:** Step 7 presents summary with "Remaining Decisions" but no mechanism to collect answers

- `specs/package-publishing-strategy/02-specification.md`: Example specification with open questions
  - **Takeaway:** "Open Questions" section (lines 1617-1694) contains 12 numbered questions
  - **Takeaway:** Questions have varied formats: some with options/recommendations, others open-ended
  - **Takeaway:** Questions cover technical decisions, policy decisions, and missing information

- `.claude/commands/spec/create.md`: Spec creation command
  - **Takeaway:** Generates comprehensive specs with 17 required sections including "Open Questions"
  - **Takeaway:** No built-in mechanism to resolve questions after creation
  - **Takeaway:** Expects questions to be answered manually before decomposition

---

## 3) Codebase Map

- **Primary components/modules:**
  - `.claude/commands/ideate-to-spec.md` - Main workflow command (needs modification)
  - `.claude/commands/spec/create.md` - Spec generation (no changes needed)
  - ClaudeKit's `/spec:validate` command - Validation logic (external, no changes)

- **Shared dependencies:**
  - AskUserQuestion tool - For interactive prompting (already used in Step 2)
  - Read tool - To parse spec files
  - Edit tool - To update spec with answers
  - Grep tool - To locate "Open Questions" section

- **Data flow:**
  - User runs `/ideate-to-spec <ideation-path>`
  - Step 1-5: Extract decisions, create spec via `/spec:create`
  - Step 6: Run `/spec:validate` → **NEW: Parse validation output for open questions signal**
  - **NEW Step 6a: Read spec file → Extract "Open Questions" section**
  - **NEW Step 6b: For each question → Use AskUserQuestion → Record answer**
  - **NEW Step 6c: Update spec file with answers using Edit tool**
  - **NEW Step 6d: Re-run `/spec:validate` → Loop if questions remain**
  - Step 7: Present summary (now includes resolved questions)

- **Feature flags/config:** None

- **Potential blast radius:**
  - Changes to `.claude/commands/ideate-to-spec.md` only
  - No changes to other commands
  - Backward compatible (specs without open questions still work)
  - No changes to spec file structure

---

## 4) Root Cause Analysis

N/A - This is a feature request, not a bug fix.

---

## 5) Research

### Potential Solutions

#### Solution 1: Iterative Loop with Edit-in-Place (RECOMMENDED)

**Approach:**
After `/spec:validate`, add new steps to `/ideate-to-spec`:
- Step 6a: Read spec file and parse "Open Questions" section
- Step 6b: For each unanswered question, use AskUserQuestion with:
  - Question text as the prompt
  - Options/recommendations from spec as answer choices (if present)
  - Open-ended "Other" option for free-form answers
- Step 6c: Use Edit tool to replace each question with "Answer: {user response}"
- Step 6d: Re-run `/spec:validate` to confirm spec is now complete
- Step 6e: If validation still shows open questions, loop back to Step 6a

**Pros:**
- Preserves full spec context (users can see spec between questions)
- Edit tool ensures atomic updates to spec file
- Natural integration with existing Step 2 pattern
- Validation loop guarantees completeness before decomposition
- Clear audit trail in spec file (questions → answers)

**Cons:**
- Requires parsing markdown structure to find questions
- Edit tool may be fragile if question format varies
- Could be confusing if spec file changes externally during flow

**Technical Requirements:**
- Markdown parsing: Use Grep with pattern `^\d+\.\s+\*\*.*\*\*` to find numbered questions
- Question extraction: Parse question number, text, context, options
- Answer formatting: Replace question with answer in consistent format
- Loop control: Parse `/spec:validate` output to detect remaining questions

---

#### Solution 2: Pre-collect All Answers, Then Batch Update

**Approach:**
- Step 6a: Parse all open questions from spec
- Step 6b: Collect all answers from user in one session
- Step 6c: Apply all updates to spec in single Edit operation
- Step 6d: Run `/spec:validate` once at the end

**Pros:**
- Fewer file I/O operations
- Single validation pass (faster)
- All decisions made up-front (no context switching)

**Cons:**
- Overwhelming for users with many questions (e.g., 12+ questions)
- Can't reference previous answers when answering later questions
- Harder to resume if user needs to pause mid-flow
- All-or-nothing approach (can't save partial progress)

---

#### Solution 3: Spawn Agent to Resolve Questions

**Approach:**
- Use Task tool to spawn a specialized agent for question resolution
- Agent reads spec, extracts questions, prompts user, updates spec
- Agent reports back when complete

**Pros:**
- Encapsulated logic (cleaner separation)
- Agent can use more sophisticated parsing
- Could be reused by other commands

**Cons:**
- Overhead of agent creation
- Harder to maintain consistency with existing `/ideate-to-spec` flow
- Requires creating new agent type
- More complex for a relatively simple task

---

### Recommendation

**Solution 1: Iterative Loop with Edit-in-Place**

**Rationale:**
- Best user experience: One question at a time, with context
- Follows existing pattern in Step 2 (ideation clarifications)
- Handles edge cases: Can resume, can see progress, can reference previous answers
- Validation loop ensures specs are truly ready for decomposition
- Minimal code changes (extends existing command)
- No new agents or complex infrastructure needed

**Implementation Pattern:**
```markdown
### Step 6a: Extract Open Questions from Spec

1. Read spec file at `specs/{slug}/02-specification.md`
2. Use Grep to find "## Open Questions" section
3. Parse numbered questions using pattern: `^\d+\.\s+\*\*(.+?)\*\*`
4. For each question, extract:
   - Question number
   - Question text
   - Context (lines following question until next question or section)
   - Options/recommendations (if present)

### Step 6b: Interactive Question Resolution

For each unanswered question (where no "Answer:" line exists):

1. Present question to user with AskUserQuestion:
   - header: "Question {N}"
   - question: "{Question text from spec}"
   - options: Extracted from context (or generic Yes/No/Custom if none)
   - multiSelect: false (single choice per question)

2. Record user's answer

### Step 6c: Update Spec with Answers

For each answered question:

1. Use Edit tool to find the question block
2. Replace pattern:
   ```
   {N}. **{Question}**
   {Context}
   ```

   With:
   ```
   {N}. ~~**{Question}**~~ (RESOLVED)
   **Answer:** {User's choice}
   {Original context preserved for reference}
   ```

### Step 6d: Validation Loop

1. Run `/spec:validate specs/{slug}/02-specification.md`
2. If validation reports open questions remain:
   - Return to Step 6a
3. If validation passes:
   - Proceed to Step 7 (summary)
```

---

## 6) Clarification

### Clarifications for User Decisions

1. **Question Format Flexibility**
   - How should we handle questions that don't follow the numbered format?
   - Should we require strict markdown formatting or be more permissive?
   - **Recommendation:** Be permissive - if we can't parse, ask user to answer in free-form

2. **Answer Format in Updated Spec**
   - Should answered questions be:
     - A) Strikethrough with answer below (keeps question visible)
     - B) Replaced entirely with answer (cleaner but loses context)
     - C) Moved to new "Resolved Questions" section (separate from Open Questions)
   - **Recommendation:** Option A (strikethrough) - preserves audit trail

3. **Validation Failure Handling**
   - If `/spec:validate` fails for reasons OTHER than open questions, should we:
     - A) Stop the flow and ask user to fix manually
     - B) Show validation errors and continue with question resolution
     - C) Attempt to fix validation issues automatically
   - **Recommendation:** Option B - show warnings but don't block question resolution

4. **Partial Progress Saving**
   - Should we save answers as we go (edit-in-place) or collect all answers first?
   - **Recommendation:** Save as we go (edit-in-place) for recoverability

5. **Context Display**
   - When asking each question, should we:
     - A) Show only the question text
     - B) Show question + context from spec (options, recommendations, etc.)
     - C) Show entire spec section for full context
   - **Recommendation:** Option B - question + relevant context without overwhelming user

6. **Multi-Select Questions**
   - Should any questions support multiple selections (e.g., "Which package managers to support?")?
   - How do we detect when multi-select is appropriate?
   - **Recommendation:** Default to single-select unless question explicitly says "select all" or "multiple"

7. **Question Dependencies**
   - Should we detect when Question N depends on Question M's answer?
   - If yes, should we reorder questions or skip based on prior answers?
   - **Recommendation:** Ask questions in order, don't auto-skip (keeps flow simple)

8. **Maximum Questions Threshold**
   - If a spec has 20+ open questions, should we:
     - A) Warn user and suggest breaking into multiple specs
     - B) Process all questions regardless of count
     - C) Batch into groups (e.g., 5 at a time with breaks)
   - **Recommendation:** Option A - warn if >10 questions, but still allow proceeding

9. **Re-validation Limit**
   - How many validation loops before we stop?
   - Should there be a maximum (e.g., 3 iterations) to prevent infinite loops?
   - **Recommendation:** Max 5 iterations, then warn user about possible spec quality issues

10. **External Question Changes**
    - If user manually edits spec between questions, should we:
      - A) Detect changes and warn
      - B) Re-parse questions each loop iteration
      - C) Lock the file during question resolution
    - **Recommendation:** Option B - re-parse each iteration (handles manual edits gracefully)

---

## 7) Integration Points

### Command Integration

**Modified Command:**
- `.claude/commands/ideate-to-spec.md` - Add Steps 6a-6d between current Step 6 and Step 7

**Called Commands:**
- `/spec:create` - No changes (Step 5)
- `/spec:validate` - No changes (Step 6 and Step 6d)

**Tools Used:**
- `Read` - Parse spec file (Step 6a)
- `Grep` - Extract "Open Questions" section (Step 6a)
- `AskUserQuestion` - Interactive prompting (Step 6b) - already used in Step 2
- `Edit` - Update spec with answers (Step 6c)
- `SlashCommand` - Call `/spec:validate` (Step 6d)

### Data Flow Diagram

```
┌─────────────────────────────────────────────────────────────────┐
│ /ideate-to-spec <ideation-path>                                │
└─────────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│ Steps 1-5: Extract slug, gather decisions, create spec         │
└─────────────────────────────────────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 6: Run /spec:validate                                     │
└─────────────────────────────────────────────────────────────────┘
                           │
                           ▼
                  ┌────────────────┐
                  │ Validation OK? │
                  └────────────────┘
                      │         │
                  Yes │         │ No (or has open questions)
                      │         │
                      │         ▼
                      │   ┌─────────────────────────────────────┐
                      │   │ Step 6a: Read & Parse Open Questions│
                      │   └─────────────────────────────────────┘
                      │                  │
                      │                  ▼
                      │   ┌─────────────────────────────────────┐
                      │   │ Any unanswered questions?           │
                      │   └─────────────────────────────────────┘
                      │           │                      │
                      │       Yes │                      │ No
                      │           │                      │
                      │           ▼                      │
                      │   ┌─────────────────────────────┐│
                      │   │ Step 6b: Ask Question       ││
                      │   │ (Use AskUserQuestion)       ││
                      │   └─────────────────────────────┘│
                      │           │                      │
                      │           ▼                      │
                      │   ┌─────────────────────────────┐│
                      │   │ Step 6c: Update Spec        ││
                      │   │ (Use Edit tool)             ││
                      │   └─────────────────────────────┘│
                      │           │                      │
                      │           ▼                      │
                      │   ┌─────────────────────────────┐│
                      │   │ More questions?             ││
                      │   └─────────────────────────────┘│
                      │      │                     │     │
                      │  Yes │                     │ No  │
                      │      └─────────────────────┘     │
                      │           ▲                      │
                      │           │                      │
                      │           ▼                      │
                      │   ┌─────────────────────────────┐│
                      │   │ Step 6d: Re-validate        ││
                      │   └─────────────────────────────┘│
                      │           │                      │
                      │           └──────────────────────┘
                      │                                  │
                      ▼                                  ▼
┌─────────────────────────────────────────────────────────────────┐
│ Step 7: Present Summary (now includes resolved questions)      │
└─────────────────────────────────────────────────────────────────┘
```

---

## 8) Success Criteria

### Functional Requirements

1. **Question Detection**
   - ✅ Correctly parse "Open Questions" section from spec file
   - ✅ Extract all numbered questions with context
   - ✅ Detect when questions have already been answered
   - ✅ Handle questions without options/recommendations (open-ended)

2. **Interactive Resolution**
   - ✅ Present questions one at a time using AskUserQuestion
   - ✅ Include question context (options, recommendations) in prompt
   - ✅ Allow user to select from options or provide custom answer
   - ✅ Record answers in structured format

3. **Spec Updates**
   - ✅ Update spec file with answers using Edit tool
   - ✅ Preserve original question text (strikethrough)
   - ✅ Format answers consistently
   - ✅ Maintain spec file structure and formatting

4. **Validation Loop**
   - ✅ Re-validate spec after answering questions
   - ✅ Loop until no open questions remain
   - ✅ Prevent infinite loops (max 5 iterations)
   - ✅ Handle validation failures gracefully

5. **User Experience**
   - ✅ Clear progress indication ("Question 3 of 12")
   - ✅ Summary shows resolved questions in Step 7
   - ✅ Workflow completes only when spec is ready for decomposition
   - ✅ Consistent with existing Step 2 interaction pattern

### Non-Functional Requirements

1. **Robustness**
   - Handle specs with 0 open questions (skip to Step 7)
   - Handle specs with malformed questions (ask free-form)
   - Recover from Edit failures (retry or manual fallback)

2. **Backward Compatibility**
   - Existing `/ideate-to-spec` usage without open questions still works
   - No changes to spec file format required
   - Works with specs created by current `/spec:create`

3. **Maintainability**
   - Code changes localized to `.claude/commands/ideate-to-spec.md`
   - Clear separation between Steps 6, 6a-d, and 7
   - Documented edge cases and error handling

---

## 9) Edge Cases & Error Scenarios

### Edge Case 1: No Open Questions in Spec
- **Scenario:** Spec is generated without any open questions
- **Behavior:** Skip Steps 6a-6d, proceed directly to Step 7
- **Detection:** "Open Questions" section is empty or says "None"

### Edge Case 2: Question Already Answered
- **Scenario:** User manually answered a question before running command
- **Behavior:** Detect "Answer:" line exists, skip that question
- **Detection:** Grep for `Answer:` below question number

### Edge Case 3: Malformed Question Section
- **Scenario:** Questions don't follow numbered format
- **Behavior:** Present entire section as free-form question
- **Fallback:** Ask user to review and update manually if parsing fails

### Edge Case 4: Very Long Context
- **Scenario:** Question context is 500+ characters
- **Behavior:** Truncate context to first 200 chars + "..."
- **User Action:** Can read full context in spec file

### Edge Case 5: Validation Fails for Non-Question Reasons
- **Scenario:** Spec has other validation issues (missing sections, etc.)
- **Behavior:** Display validation warnings but continue with question resolution
- **Note:** Don't block on warnings, only on critical errors

### Edge Case 6: User Selects "Other" for All Questions
- **Scenario:** User provides custom answers for all questions
- **Behavior:** Accept free-form text, format as "Answer: {text}"
- **Validation:** No constraints on answer content

### Edge Case 7: Maximum Iterations Reached
- **Scenario:** After 5 validation loops, questions still remain
- **Behavior:** Warn user, show remaining questions, ask whether to continue or exit
- **Recovery:** Allow manual spec editing before retry

### Edge Case 8: External Spec Edit During Flow
- **Scenario:** User edits spec file between questions
- **Behavior:** Re-parse questions each iteration, detect changes
- **Safety:** Edit tool will fail if context doesn't match (prevents corruption)

---

## 10) Alternative Approaches Considered

### Alternative 1: Manual Question Resolution (Status Quo)
- **Approach:** User manually edits spec to answer questions
- **Why Rejected:** Friction in workflow, easy to forget, not enforced before decomposition

### Alternative 2: LLM Auto-Answer Questions
- **Approach:** Use Claude to suggest answers based on spec context
- **Why Rejected:** User decisions are critical, shouldn't be automated; defeats purpose of clarifications

### Alternative 3: Create Separate "Answers" File
- **Approach:** Store answers in `specs/{slug}/02-answers.md` separate from spec
- **Why Rejected:** Splits context, harder to review, spec should be self-contained

### Alternative 4: Modify /spec:create to Avoid Questions
- **Approach:** Change spec generation to not produce open questions
- **Why Rejected:** Open questions are valuable for capturing unknowns; removing them reduces spec quality

---

## 11) Testing Strategy

### Manual Testing

1. **Happy Path Test**
   - Create ideation document with clarifications
   - Run `/ideate-to-spec`
   - Verify spec is created with open questions
   - Verify questions are presented interactively
   - Answer all questions
   - Verify spec is updated correctly
   - Verify validation passes
   - Verify summary shows resolved questions

2. **No Questions Test**
   - Create ideation without clarifications
   - Run `/ideate-to-spec`
   - Verify spec is created without open questions
   - Verify Steps 6a-6d are skipped
   - Verify flow completes normally

3. **Partial Manual Resolution Test**
   - Create spec with 5 open questions
   - Manually answer 2 questions in spec
   - Run `/ideate-to-spec`
   - Verify only 3 questions are asked
   - Verify manual answers are preserved

4. **Validation Loop Test**
   - Create spec with complex questions
   - Answer questions with vague responses
   - Verify re-validation triggers if needed
   - Verify loop completes after clarifications

### Edge Case Testing

1. **Malformed Questions Test**
   - Create spec with non-standard question format
   - Verify graceful handling (free-form fallback)

2. **Max Iterations Test**
   - Create spec with circular dependencies
   - Verify max iteration limit prevents infinite loop
   - Verify clear error message

3. **External Edit Test**
   - Start question resolution
   - Manually edit spec during flow
   - Verify re-parsing detects changes
   - Verify Edit tool safety prevents corruption

---

## 12) Documentation Requirements

### Command Documentation Updates

**File:** `.claude/commands/ideate-to-spec.md`

**Sections to Add:**
- Step 6a: Extract Open Questions from Spec (new)
- Step 6b: Interactive Question Resolution (new)
- Step 6c: Update Spec with Answers (new)
- Step 6d: Validation Loop (new)

**Sections to Update:**
- Step 7: Present Summary (add resolved questions section)

### User-Facing Documentation

**File:** `CLAUDE.md`

**Updates:**
- Phase 2: Specification section - mention open questions resolution
- Workflow diagram - update to show question resolution loop
- Example usage - show interactive question answering

**File:** `README.md`

**Updates:**
- Workflow section - document question resolution step
- Add example of open questions being resolved interactively

---

## 13) Implementation Checklist

### Phase 1: Core Question Resolution (MVP)

- [ ] Parse "Open Questions" section from spec file
- [ ] Extract numbered questions with context
- [ ] Detect already-answered questions (skip if "Answer:" exists)
- [ ] Present questions using AskUserQuestion (one at a time)
- [ ] Update spec with answers using Edit tool (strikethrough pattern)
- [ ] Re-run `/spec:validate` after answering
- [ ] Loop until validation passes or max iterations reached
- [ ] Update Step 7 summary to include resolved questions

### Phase 2: Robustness & Error Handling

- [ ] Handle specs with no open questions (skip Steps 6a-6d)
- [ ] Handle malformed questions (free-form fallback)
- [ ] Max iteration limit (5) with clear warning
- [ ] External edit detection (re-parse each iteration)
- [ ] Edit tool failure recovery (retry or manual prompt)
- [ ] Long context truncation (200 char limit for display)
- [ ] Validation failure handling (show warnings, continue)

### Phase 3: Documentation & Testing

- [ ] Update `.claude/commands/ideate-to-spec.md`
- [ ] Update `CLAUDE.md` workflow documentation
- [ ] Update `README.md` with examples
- [ ] Manual testing of happy path
- [ ] Manual testing of edge cases
- [ ] Create example spec with resolved questions for reference

---

## 14) Open Design Questions

1. **Question Parsing Complexity**
   - Should we support nested/sub-questions (1a, 1b, etc.)?
   - Current recommendation: No, keep simple - only top-level numbered questions

2. **Answer Validation**
   - Should we validate answer format/content before saving?
   - Current recommendation: No validation - accept any user input

3. **Question Reordering**
   - Should users be able to answer questions out of order?
   - Current recommendation: No - sequential order maintains simplicity

4. **Undo Mechanism**
   - Should users be able to undo an answer and re-answer?
   - Current recommendation: No - manual edit if correction needed

5. **Summary Detail Level**
   - How much detail should Step 7 include about resolved questions?
   - Current recommendation: List question numbers + user choices, not full text

---

## 15) Future Enhancements (Out of Scope)

1. **Question Templates**
   - Pre-defined question templates for common decision points
   - Would reduce manual question writing in specs

2. **AI-Suggested Answers**
   - Provide LLM-suggested answers based on spec context
   - User can accept/reject/modify suggestions

3. **Multi-Spec Question Propagation**
   - If similar question appears in multiple specs, answer once and apply to all
   - Useful for policy/architecture decisions

4. **Question Analytics**
   - Track which questions are most common across specs
   - Identify patterns for improving spec generation

5. **Collaborative Decision Making**
   - Allow multiple team members to answer different questions
   - Requires integration with version control/review system

---

## 16) References

- **Example Spec:** specs/package-publishing-strategy/02-specification.md (lines 1617-1694)
- **Current Command:** .claude/commands/ideate-to-spec.md
- **Spec Creation:** .claude/commands/spec/create.md
- **ClaudeKit Validation:** `/spec:validate` command (ClaudeKit)
- **AskUserQuestion Tool:** Claude Code built-in tool for interactive prompting
